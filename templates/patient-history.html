<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Patient History - Health Monitor</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>

  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .navbar {
      background-color: #004d99;
    }

    .navbar-brand, .nav-link {
      color: white !important;
    }

    .header {
      background-color: #004d99;
      color: white;
      padding: 2rem 1rem;
      text-align: center;
      border-bottom: 5px solid #0099ff;
    }

    .header h2 {
      font-size: 1.8rem;
    }

    .header p {
      font-size: 1rem;
    }

    .table-wrapper {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
    }

    .search-bar {
      flex-direction: column;
      gap: 0.5rem;
    }

    @media (min-width: 576px) {
      .search-bar {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="bi bi-heart-pulse-fill me-1"></i> Health Monitor</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse mt-2 mt-lg-0" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="/">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link active" href="/history">History</a></li>
          <li class="nav-item"><a class="nav-link" href="/real-time-ecg">ECG Graph</a></li>
          <li class="nav-item"><a class="nav-link active" href="/ai-prediction">AI Prediction</a></li>
          <li class="nav-item"><a class="nav-link" href="/report-generator">AI Report</a></li>
          <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <div class="header">
    <h2><i class="bi bi-journal-medical"></i> Patient History</h2>
    <p>Last 100 entries from the database</p>
  </div>

  <!-- Content -->
  <div class="container py-4">
    <div class="table-wrapper">
      <div class="d-flex search-bar mb-3">
        <input type="text" id="searchInput" class="form-control w-100 w-sm-50" placeholder="üîç Search by Device ID">
        <button class="btn btn-success ms-sm-3 mt-2 mt-sm-0" onclick="exportCSV()">
          <i class="bi bi-file-earmark-arrow-down"></i> Export CSV
        </button>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle text-center">
          <thead class="table-dark">
            <tr>
              <th>Timestamp</th>
              <th>Device ID</th>
              <th>Pulse Rate</th>
              <th>Temperature (¬∞C)</th>
              <th>ECG Value</th>
            </tr>
          </thead>
          <tbody id="historyTable">
            <tr><td colspan="5">‚è≥ Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination Controls -->
      <nav class="mt-3 d-flex justify-content-center" id="pagination"></nav>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    let allData = [];
    let currentPage = 1;
    const rowsPerPage = 50;

    async function fetchHistory() {
      const res = await fetch('/all-data');
      const data = await res.json();
      allData = data;
      displayPage(allData, currentPage);
      setupPagination(allData);
    }

    function displayPage(data, page) {
      const tbody = document.getElementById('historyTable');
      tbody.innerHTML = '';

      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const paginatedData = data.slice(start, end);

      if (paginatedData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No matching results</td></tr>';
        return;
      }

      paginatedData.forEach(entry => {
        const row = `
          <tr>
            <td>${entry.timestamp || '--'}</td>
            <td>${entry.device_id || '--'}</td>
            <td>${entry.pulse_value ?? '--'}</td>
            <td>${entry.temperature ?? '--'}</td>
            <td>${entry.ecg_value ?? '--'}</td>
          </tr>`;
        tbody.innerHTML += row;
      });
    }

    function setupPagination(data) {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      const pageCount = Math.ceil(data.length / rowsPerPage);

      for (let i = 1; i <= pageCount; i++) {
        const btn = document.createElement('button');
        btn.className = `btn btn-sm mx-1 ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'}`;
        btn.innerText = i;
        btn.addEventListener('click', () => {
          currentPage = i;
          displayPage(data, currentPage);
          setupPagination(data);
        });
        pagination.appendChild(btn);
      }
    }

    function exportCSV() {
      let csv = 'Timestamp,Device ID,Pulse Rate,Temperature (¬∞C),ECG Value\n';
      allData.forEach(entry => {
        csv += `${entry.timestamp},${entry.device_id},${entry.pulse_value ?? ''},${entry.temperature ?? ''},${entry.ecg_value ?? ''}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'patient_history.csv';
      link.click();
    }

    document.getElementById("searchInput").addEventListener("input", function(e) {
      const keyword = e.target.value.toLowerCase();
      const filtered = allData.filter(d => d.device_id?.toLowerCase().includes(keyword));
      currentPage = 1;
      displayPage(filtered, currentPage);
      setupPagination(filtered);
    });

    window.onload = fetchHistory;
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
